OK, I'm going to need help rewriting my tests for this library because we just ripped middleware out and now we are depending on injectable services to play the function that middleware used to play in the past so here are my tests and my library. Can you please ref factor my test and provide full files to me so that I can replace them in my code basin make them up-to-date with the new standards of using injectable services instead of middleware thank you so much. I appreciate the help.